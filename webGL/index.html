<!DOCTYPE HTML>
<html>
<head>

	<meta http-equiv='content-type' content='text/html; charset=utf-8' />
	<meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no'>

	<title>Parallax Test</title>
	
	<script type='text/javascript' src='../libs/d3.js'></script>
	<script type='text/javascript' src='../libs/pixi.js'></script>
	<script type='text/javascript' src='../libs/d3.geo.projections.js'></script>
	<script type='text/javascript' src='../libs/d3.topojson.js'></script>
	<script type='text/javascript' src='../libs/jquery.js'></script>
	<script type='text/javascript' src='../libs/bootstrap.min.js'></script>



	<link href='https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz:400,700,300,200' rel='stylesheet' type='text/css'>

	<link rel='stylesheet' type='text/css' href='../libs/bootstrap.css'>
	<link rel='stylesheet' type='text/css' href='../libs/font.awesome.min.css'>
	<link rel='stylesheet' type='text/css' href='../css/css.css'>

	<style type="text/css">
		body {
			background-color: #FFF;
		}
	</style>

</head>

<body>

	<div class='container-fluid'>

		<div class='row'>
			<div id='svg-container'>
			</div>

			<div id='btn-container'>
				
			</div>

		</div>

	</div>


	<script type='text/javascript'>

		var sw = window,
			sd = document,
			se = sd.documentElement,
			sg = sd.getElementsByTagName('body')[0],
			sx = sw.innerWidth || se.clientWidth || sg.clientWidth,
			sy = sw.innerHeight|| se.clientHeight|| sg.clientHeight;
		//alert(x + ' Ã— ' + y);

		var __svg__ = { w: sx, h: sy, pt: sy * .22, pr: sx * .22, pb: sy * .22, pl: sx * .22 };

		// CREATE THE STEP DATA
		var data = [
			{
				action: 'draw',
				chart: 'unit',
				type: 'absolute',
				distribtion: 'ordered',
				data: [
					{ n: 'Nigeria', v: 2062 },
					{ n: 'Iraq', v: 1516 },
					{ n: 'Afghanistan', v: 1052 },
					{ n: 'Turkey', v: 709 },
					{ n: 'Syria', v: 684 }
				],
				highlight: { v: ['cat 4'], c: '#9e4e40' }, 
				units: { t: 'isotype', l: 'grid', lbl: 'A civilian harmed in' },
				text: { p: 'Nigeria, Iraq, Afghanistan, Turkey and Syria were most affected: over 6,000 civilians were harmed by suicide attackers in these countries.', x: 50.2, y: 5, w: 75, s: 'fast', c: null },
				background: '#333'
			},
			{
				action: 'update',
				chart: 'unit',
				type: 'absolute',
				distribtion: 'random',
				data: [
					{ n: 'Killed', v: 2550 },
					{ n: 'Injured', v: 6559 }
				], 
				highlight: { v: ['Killed'], c: '#9e4e40' },
				units: { t: 'isotype', l: 'grid', lbl: 'A civilian ' },
				//units: { t: 'bubble', l: 'force' }
				text: { p: 'All together, there were 248 bombings worldwide, which harmed 9109 civilians. Almost one out of three of these people were killed, while the others were injured.', x: 0, y: 25, w: 75, s: 'slow', c: null },
				color: '#c6c7b7',
				background: '#333'
			},
		]

		function dotheMath (stepdata) {
			// GET NUMBER OF CATEGORIES
			/*var categories = stepdata.data.map(function (d) {
				return d.n;
			});
			categories = categories.getUnique();*/
			var totalcount = stepdata.data.map(function (d) {
				return d.v;
			});
			totalcount = d3.sum(totalcount);

			var ncat = stepdata.data.length;
			var ow, oh, r = 20 / 30;
			ow = Math.floor(__svg__.w / ncat);
			oh = ow / r;

			var oxoffset = (__svg__.w - ncat * ow) / 2,
				oyoffset = (__svg__.h - oh) / 2;

			var w, h;
			h = Math.floor(Math.sqrt(((__svg__.w * __svg__.h) / totalcount) / r));
			w = h * r;

			var nrow = Math.floor(__svg__.w / w),
				row = 0;

			var unitsdata = new Array();

			var u = nrow * w,
				ncol = totalcount / nrow;
			if (Math.round(ncol) < ncol) {
				ncol = Math.round(ncol) + 1;
			} else {
				ncol = Math.round(ncol);
			}
			
			// CHECK IF THERE IS A LAST INCOMPLETE LINE SO IT DOES NOT FLOW OUT OF VIEW
			th = __svg__.h / ncol;
			if (th < h) {
				h = Math.floor(th);
				w = h * r;
			}

			var xoffset = (__svg__.w - nrow * w) / 2,
				yoffset = (__svg__.h - ncol * h) / 2;
			

			var unitcount = -1;
			stepdata.data.forEach(function (d, i) {
				for (var j = 0; j < d.v; j ++) {
					var x, y;
					unitcount ++;
					if (unitcount !== 0 && unitcount % nrow == 0) row ++;
					unitsdata.push({ v: j, x: (xoffset + (unitcount - row * nrow) * w), y: yoffset + row * h, n: d.n, t: i, idx: unitcount });
				};
			});

			return [unitsdata, w, xoffset, yoffset];
		}


		var math = dotheMath(data[0]); // HERE 0 REPRESENTS THE STEP
		var unitData = math[0];
		

		

		var humans = [];
		var humanFrames = ['picto.png'];

		var count = 0;

		var stage = new PIXI.Container();

		// create a renderer instance.
		var renderer = new PIXI.CanvasRenderer(__svg__.w, __svg__.h, null, true);
		//renderer.backgroundColor = 0x3498db;
		// add the renderer view element to the DOM
		document.body.appendChild(renderer.view);

		// create an empty container
		var humanContainer = new PIXI.Container();

		stage.addChild(humanContainer);

		var humantexture = new PIXI.Texture.fromImage('isotype_symbol.svg');


		for (var i = 0; i < unitData.length; i++) {
			var frameName = humanFrames[0];

			var human = new PIXI.Sprite(humantexture)
			human.position.x = 0; //unitData[i].x;
			human.position.y = 0; //unitData[i].y;
			human.anchor.x = 0;
			human.anchor.y = 0;
			human.scale.x = Math.round((math[1] / 20) * 100) / 100;
			human.scale.y = Math.round((math[1] / 20) * 100) / 100;
			human.tint = 0x66FF99;
			human.alpha = 1;
			human['__data__'] = unitData[i];

			human.interactive = true;
			human.mouseup = human.touchend = function () {
				console.log(d3.select(this).datum().n)
			}

			humans.push(human);
			humanContainer.addChild(human);
		}

		//requestAnimationFrame(animate);


		function animate() {	
		    // render the stage   
		    requestAnimationFrame(animate);
		    
		    humans.forEach(function (d, i) {
		    	var human = d;
		    	var padd = 10;
		    	var data = d3.select(d).datum();

		    	//human.scale.x = Math.round((math[1] / 20) * 100) / 100;
		    	//human.scale.y = Math.round((math[1] / 20) * 100) / 100;


		    	if (human.x > data.x + padd) {
		    		human.x -= Math.random() * 10;
		    	} else if (human.x < data.x - padd) {
		    		human.x += Math.random() * 10;
		    	} else {
		    		human.x = data.x;
		    	}

		    	if (human.y > data.y + padd) {
		    		human.y -= Math.random() * 10;
		    	} else if (human.y < data.y - padd) {
		    		human.y += Math.random() * 10;
		    	} else {
		    		human.y = data.y;
		    	}

		    	/*if (human.alpha < 1) {
		    		human.alpha += 1 / i;
		    	} else {
		    		human.alpha = 1;
		    	}*/

		    	
		    });

		    /*count += 10;
		    for (var j = count - 10; j < count; j++) {
		    	if (j < humans.length) humans[j].alpha = 1;
		    }*/
		    //humans[count].alpha = 1;

		    renderer.render(stage);
		}


		d3.select('body').on('mouseup',function () {
			requestAnimationFrame(animate);
		})
	


	</script>

</body>

</html>